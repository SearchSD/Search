<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Profile</title>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=VT323&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="/style.css" rel="stylesheet">
</head>

<body>
    <div class="container">
        <a href="#" onclick="window.close(); return false;" class="back-btn">
            <span class="material-icons">arrow_back</span>
            Back to Search
        </a>

        <div class="profile-header">
            <div class="profile-top">
                <div class="profile-avatar" id="profileAvatar">ST</div>
                <div class="profile-info">
                    <h1 id="studentName">Loading...</h1>
                    <div class="id" id="studentId"></div>
                    <div class="quick-stats" id="quickStats"></div>
                </div>
            </div>
        </div>

        <div class="details-section" id="detailsSection"></div>

        <div class="no-data" id="noData" style="display: none;">
            <span class="material-icons">person_off</span>
            <h3>No student data found</h3>
            <p>Please navigate from the search page.</p>
        </div>
    </div>

    <div class="toast" id="toast">
        <span class="material-icons">check_circle</span>
        <span id="toastMessage">Copied to clipboard!</span>
    </div>

    <script>
        // Check authentication
        if (sessionStorage.getItem('isAuthenticated') !== 'true') {
            window.location.href = 'index.html';
        }

        // Toast notification function
        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }

        // Copy to clipboard function
        function copyToClipboard(text, label) {
            navigator.clipboard.writeText(text).then(() => {
                showToast(`${label} copied!`);
            }).catch(err => {
                console.error('Failed to copy:', err);
                showToast('Failed to copy');
            });
        }

        const studentData = localStorage.getItem('currentStudent');
        const headersData = localStorage.getItem('csvHeaders');

        if (!studentData) {
            document.getElementById('noData').style.display = 'block';
            document.getElementById('detailsSection').style.display = 'none';
            document.querySelector('.profile-header').style.display = 'none';
        } else {
            const student = JSON.parse(studentData);
            const headers = headersData ? JSON.parse(headersData) : Object.keys(student);

            // Set profile header
            const initials = (student._displayName || 'Student').split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            document.getElementById('profileAvatar').textContent = initials;
            document.getElementById('studentName').textContent = student._displayName || 'Student';
            document.getElementById('studentId').textContent = student._displayId || '';

            // Quick Stats
            const quickStatsEl = document.getElementById('quickStats');
            const stats = [];

            if (student['Class'] && student['Class'] !== 'N/A') {
                stats.push({ label: 'Class', value: `${student['Class']} ${student['Section'] || ''}` });
            }
            if (student['Gender'] && student['Gender'] !== 'N/A') {
                stats.push({ label: 'Gender', value: student['Gender'] });
            }
            if (student['Marks obtained(in %)'] && student['Marks obtained(in %)'] !== 'N/A') {
                stats.push({ label: 'Marks', value: student['Marks obtained(in %)'] + '%' });
            }
            if (student['DOB'] && student['DOB'] !== 'N/A') {
                stats.push({ label: 'DOB', value: student['DOB'] });
            }

            stats.forEach(stat => {
                const div = document.createElement('div');
                div.className = 'stat';
                div.innerHTML = `
                    <div class="stat-label">${stat.label}</div>
                    <div class="stat-value">${stat.value}</div>
                `;
                quickStatsEl.appendChild(div);
            });

            // Group fields by category
            const categories = {
                'Contact Information': {
                    icon: 'contact_phone',
                    fields: ['Mobile No.', 'Alternate Mobile No.', 'Contact Email Id', 'Address', 'Pincode']
                },
                'Family Information': {
                    icon: 'family_restroom',
                    fields: ['Father Name', 'Mother Name', 'Guardian Name']
                },
                'Academic Information': {
                    icon: 'school',
                    fields: ['Medium Of Instruction', 'Languages Group', 'Academic Stream', 'Subjects Group', 'No. of days Student attended in school']
                },
                'Personal Information': {
                    icon: 'person',
                    fields: ['Name As per AADHAAR', 'AADHAAR No.', 'Blood Group']
                }
            };

            const detailsSection = document.getElementById('detailsSection');

            Object.entries(categories).forEach(([categoryName, config]) => {
                const validFields = config.fields.filter(f =>
                    student[f] && student[f] !== 'N/A' && student[f] !== 'NA'
                );

                if (validFields.length === 0) return;

                const section = document.createElement('div');
                section.className = 'section';

                const title = document.createElement('h2');
                title.className = 'section-title';
                title.innerHTML = `
                    <span class="material-icons">${config.icon}</span>
                    ${categoryName}
                `;
                section.appendChild(title);

                const grid = document.createElement('div');
                grid.className = 'details-grid';

                validFields.forEach(field => {
                    const item = document.createElement('div');
                    item.className = 'detail-item';

                    const label = document.createElement('div');
                    label.className = 'detail-label';
                    label.textContent = field;

                    const value = document.createElement('div');
                    value.className = 'detail-value';

                    // Check if this is a phone or email field to make it copyable
                    const isPhone = field.toLowerCase().includes('mobile') || field.toLowerCase().includes('phone');
                    const isEmail = field.toLowerCase().includes('email');

                    if (isPhone || isEmail) {
                        const copyableSpan = document.createElement('span');
                        copyableSpan.className = 'copyable';
                        copyableSpan.textContent = student[field];
                        copyableSpan.title = 'Click to copy';
                        copyableSpan.onclick = () => {
                            const labelText = isPhone ? 'Phone number' : 'Email';
                            copyToClipboard(student[field], labelText);
                        };
                        value.appendChild(copyableSpan);
                    } else {
                        value.textContent = student[field];
                    }

                    item.appendChild(label);
                    item.appendChild(value);
                    grid.appendChild(item);
                });

                section.appendChild(grid);
                detailsSection.appendChild(section);
            });
        }
    </script>
</body>

</html>
